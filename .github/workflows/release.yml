name: ðŸ”– Release

on:
  push:
    branches:
      - master

permissions:
  contents: write  # å…è®¸åˆ›å»º tag å’ŒæŽ¨é€æ›´æ”¹
  pull-requests: write  # å…è®¸åˆ›å»º PR

jobs:
  release:
    name: ðŸ“¦ åˆ›å»ºå‘å¸ƒç‰ˆæœ¬
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.bump_version.outputs.version_changed }}
      new_version: ${{ steps.bump_version.outputs.new_version }}

    steps:
      # 1. æ£€å‡ºä»£ç ï¼ˆèŽ·å–å®Œæ•´åŽ†å²è®°å½•ä»¥ä¾¿åˆ†æž master åˆ†æ”¯çš„æäº¤, åˆ†æžä¸Šæ¬¡ tag åˆ°çŽ°åœ¨çš„æäº¤ï¼‰
      - name: ðŸ“¥ æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v5.0.0
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_TOKEN }}

      # 2. é…ç½® Git ç”¨æˆ·ä¿¡æ¯
      - name: âš™ï¸ é…ç½® Git ç”¨æˆ·
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      # 3. è®¾ç½® Python çŽ¯å¢ƒ
      - name: ðŸ è®¾ç½® Python çŽ¯å¢ƒ
        uses: actions/setup-python@v6.0.0
        with:
          python-version: "3.14"

      # 4. å®‰è£… Commitizenï¼ˆå‘ç‰ˆå·¥å…·ï¼‰
      - name: ðŸ“¦ å®‰è£… Commitizen
        run: pip install commitizen

      # 5. è‡ªåŠ¨å‡çº§ç‰ˆæœ¬å·å¹¶ç”Ÿæˆ CHANGELOG
      - name: ðŸ”– å‡çº§ç‰ˆæœ¬å·å¹¶æ›´æ–°æ—¥å¿—
        id: bump_version
        run: |
          # 1. èŽ·å–å½“å‰ç‰ˆæœ¬
          CURRENT_VERSION=$(cz version --project)
          echo "ðŸ“Œ å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

          # 2. æ‰§è¡Œç‰ˆæœ¬å‡çº§ (æ•èŽ·é€€å‡ºç )
          set +e
          cz bump --yes --changelog
          BUMP_EXIT_CODE=$?
          set -e

          # 3. èŽ·å–å‡çº§åŽçš„æ–°ç‰ˆæœ¬, å°†ç‰ˆæœ¬è¾“å‡ºåˆ° GitHub Actions å˜é‡
          NEW_VERSION=$(cz version --project)
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ æ–°ç‰ˆæœ¬: $NEW_VERSION"

          # 4. æ£€æŸ¥æ˜¯å¦æˆåŠŸå‡çº§ç‰ˆæœ¬
          if [ $BUMP_EXIT_CODE -eq 0 ]; then
            if [ "$CURRENT_VERSION" = "$NEW_VERSION" ]; then
              echo "âš ï¸  ç‰ˆæœ¬å·æœªå˜åŒ–: $CURRENT_VERSION"
              echo "version_changed=false" >> $GITHUB_OUTPUT
            else
              echo "âœ… ç‰ˆæœ¬å·²å‡çº§: $CURRENT_VERSION â†’ $NEW_VERSION"
              echo "version_changed=true" >> $GITHUB_OUTPUT
            fi
          elif [ $BUMP_EXIT_CODE -eq 21 ] || [ $BUMP_EXIT_CODE -eq 3 ]; then
            echo "version_changed=false" >> $GITHUB_OUTPUT
            if [ $BUMP_EXIT_CODE -eq 21 ]; then
              echo "â„¹ï¸  æ²¡æœ‰å¯æå‡ç‰ˆæœ¬çš„æäº¤ (é€€å‡ºç : 21 - NoneIncrementExit)"
            elif [ $BUMP_EXIT_CODE -eq 3 ]; then
              echo "â„¹ï¸  æ²¡æœ‰æ‰¾åˆ°æ–°æäº¤ (é€€å‡ºç : 3 - NoCommitsFoundError)"
            fi
          else
            echo "âŒ Bump å¤±è´¥,é€€å‡ºç : $BUMP_EXIT_CODE"
            exit $BUMP_EXIT_CODE
          fi

      # 6. æŽ¨é€ç‰ˆæœ¬æ›´æ”¹å’Œæ ‡ç­¾
      - name: ðŸš€ æŽ¨é€ç‰ˆæœ¬å˜æ›´å’Œæ ‡ç­¾
        if: steps.bump_version.outputs.version_changed == 'true'
        run: |
          git push origin master --follow-tags

      # 7. åˆ›å»º GitHub Release
      - name: ðŸ“ åˆ›å»º GitHub å‘å¸ƒ
        if: steps.bump_version.outputs.version_changed == 'true'
        uses: ncipollo/release-action@v1.20.0
        with:
          tag: ${{ steps.bump_version.outputs.new_version }}
          name: ðŸ”– Release ${{ steps.bump_version.outputs.new_version }}
          bodyFile: "CHANGELOG.md"
          draft: false
          prerelease: ${{ github.ref != 'refs/heads/master' }}
          token: ${{ secrets.GH_TOKEN }}

      # 8. è¾“å‡ºå‘å¸ƒä¿¡æ¯
      - name: âœ… å‘å¸ƒæ‘˜è¦ä¿¡æ¯
        if: steps.bump_version.outputs.version_changed == 'true'
        run: |
          echo "### ðŸŽ‰ Release åˆ›å»ºæˆåŠŸ!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ steps.bump_version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag**: \`${{ steps.bump_version.outputs.new_version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch**: \`master\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”— [æŸ¥çœ‹å‘å¸ƒ](https://github.com/${{ github.repository }}/releases/tag/${{ steps.bump_version.outputs.new_version }})" >> $GITHUB_STEP_SUMMARY
